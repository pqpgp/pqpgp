{% extends "base.html" %}

{% block title %}PQPGP - Decrypt Message{% endblock %}

{% block content %}
<div class="card">
    <h2><svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg>Decrypt Message</h2>
    <p>Decrypt a message that was encrypted for your public key using post-quantum cryptography. The system will automatically try all your available private keys.</p>
    
    {% if has_error %}
        <div class="alert alert-error">
            <strong>Decryption Failed:</strong> {{ error.as_ref().unwrap() }}
        </div>
    {% endif %}
    
    <form method="post" action="/decrypt">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="encrypted_message">Encrypted Message (PGP Armored):</label>
            <textarea name="encrypted_message" id="encrypted_message" placeholder="-----BEGIN PGP MESSAGE-----&#10;&#10;Paste the complete encrypted message here...&#10;&#10;-----END PGP MESSAGE-----" required autocomplete="off" spellcheck="false"></textarea>
            <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                Paste the complete PGP armored message including the -----BEGIN PGP MESSAGE----- and -----END PGP MESSAGE----- lines.
            </small>
        </div>
        
        <div class="form-group">
            <label for="password">Private Key Password (if protected):</label>
            <input type="password" name="password" id="password" placeholder="Enter password for encrypted private key" autocomplete="current-password" spellcheck="false">
            <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                Leave empty if your private key is not password-protected. Required if your key was generated with password protection.
            </small>
        </div>
        
        <button type="submit" class="btn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg>Decrypt Message</button>
    </form>
</div>

{% if has_result %}
<div class="card">
    <h2><svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Decryption Successful</h2>
    <p>The message has been successfully decrypted using your private key.</p>
    
    <div class="form-group">
        <label for="decrypted_output">Decrypted Message:</label>
        <div class="code-block">{{ result.as_ref().unwrap() }}</div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #f0fff4; border: 1px solid #9ae6b4; border-radius: 8px;">
        <h4 style="margin-top: 0; color: #22543d; display: flex; align-items: center;"><svg class="icon icon-lg" style="margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>Security Verification</h4>
        <ul style="margin-bottom: 0; color: #22543d;">
            <li>Message was encrypted with <strong>ML-KEM-1024</strong> post-quantum cryptography</li>
            <li>Keys and nonces were securely derived using <strong>HKDF-SHA3-512</strong></li>
            <li>Decryption was performed using your private key</li>
            <li>Message integrity was verified with <strong>AES-256-GCM</strong> authentication</li>
            <li><strong>Deterministic nonce verification</strong> ensures no replay or tampering attacks</li>
            <li>No tampering or corruption was detected</li>
        </ul>
    </div>
</div>
{% endif %}

<div class="card">
    <h2><svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>How Decryption Works</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="padding: 15px; background: var(--bg-subtle); border-radius: 8px; border-left: 4px solid var(--red-light);">
            <h4 style="margin-top: 0; color: #4a5568;">1. Key Identification</h4>
            <p>System identifies which of your private keys can decrypt the message using key ID matching.</p>
        </div>
        
        <div style="padding: 15px; background: var(--bg-subtle); border-radius: 8px; border-left: 4px solid #48bb78;">
            <h4 style="margin-top: 0; color: #4a5568;">2. Key Decapsulation</h4>
            <p>ML-KEM-1024 algorithm recovers the quantum-resistant shared secret using your private key.</p>
        </div>
        
        <div style="padding: 15px; background: var(--bg-subtle); border-radius: 8px; border-left: 4px solid #0284c7;">
            <h4 style="margin-top: 0; color: #4a5568;">3. Key Re-derivation</h4>
            <p>HKDF-SHA3-512 reproduces the exact same AES-256 keys and nonces used during encryption.</p>
        </div>
        
        <div style="padding: 15px; background: var(--bg-subtle); border-radius: 8px; border-left: 4px solid #ed8936;">
            <h4 style="margin-top: 0; color: #4a5568;">4. Message Decryption</h4>
            <p>AES-256-GCM decrypts the message and verifies metadata authentication, ensuring integrity.</p>
        </div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #fffbf0; border: 1px solid #fbd38d; border-radius: 8px;">
        <h4 style="margin-top: 0; color: #744210; display: flex; align-items: center;"><svg class="icon icon-lg" style="margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>Security Notes</h4>
        <ul style="margin-bottom: 0; color: #744210;">
            <li>Only messages encrypted specifically for your public keys can be decrypted</li>
            <li>If decryption fails, ensure the message was encrypted for one of your key IDs</li>
            <li>Tampered or corrupted messages will fail decryption due to authentication checks</li>
            <li>Your private keys never leave this system and are stored securely</li>
        </ul>
    </div>
</div>
{% endblock %}