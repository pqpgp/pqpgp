{% extends "base.html" %}

{% block title %}Conversation - {{ forum_name }}{% endblock %}

{% block content %}
<div class="card">
    <h2>Conversation with {{ peer_short }}</h2>
    <p>
        <a href="/forum/{{ forum_hash }}/pm" class="btn">&larr; Back to Inbox</a>
        <a href="/forum/{{ forum_hash }}" class="btn">&larr; Back to Forum</a>
        <form method="post" action="/forum/{{ forum_hash }}/pm/conversation/{{ conversation_id }}/delete" style="display: inline-block; margin: 0;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this conversation locally?')">Delete Conversation</button>
        </form>
    </p>
    <p>
        <strong>Peer:</strong> <span class="key-id">{{ peer_fingerprint }}</span><br>
        <strong>Conversation ID:</strong> <span class="key-id">{{ conversation_id }}</span>
    </p>

    {% if has_error %}
    <div class="alert alert-error">{{ error.as_ref().unwrap() }}</div>
    {% endif %}

    {% if has_result %}
    <div class="alert alert-success">{{ result.as_ref().unwrap() }}</div>
    {% endif %}
</div>

<!-- Messages -->
<div class="card">
    <h2>Messages ({{ total_messages }} total)</h2>
    {% if messages.is_empty() %}
    <p style="color: #718096;">No messages in this conversation yet.</p>
    {% else %}
    <div class="message-list" style="max-height: 500px; overflow-y: auto;">
        {% for msg in messages %}
        <div class="message {% if msg.is_outgoing %}message-outgoing{% else %}message-incoming{% endif %}"
             style="margin-bottom: 15px; padding: 15px; border-radius: 8px;
                    {% if msg.is_outgoing %}background-color: #e6f2ff; margin-left: 50px;{% else %}background-color: #f0f0f0; margin-right: 50px;{% endif %}">
            <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">
                {% if msg.is_outgoing %}You{% else %}{{ peer_short }}{% endif %} - {{ msg.timestamp_display }}
                {% match msg.reply_to %}
                {% when Some with (reply_id) %}
                <span style="margin-left: 10px;">(Reply to {{ reply_id|truncate(8) }}...)</span>
                {% when None %}
                {% endmatch %}
            </div>
            {% match msg.subject %}
            {% when Some with (subj) %}
            <div style="font-weight: 600; margin-bottom: 5px;">{{ subj }}</div>
            {% when None %}
            {% endmatch %}
            <div style="white-space: pre-wrap;">{{ msg.body }}</div>
            <div style="font-size: 11px; color: #a0a0a0; margin-top: 5px;">
                ID: {{ msg.message_id|truncate(16) }}...
            </div>
        </div>
        {% endfor %}
    </div>

    <div style="margin-top: 1em; display: flex; justify-content: space-between; align-items: center;">
        <span style="color: #718096; font-size: 0.9em;">Showing {{ messages.len() }} of {{ total_messages }} messages</span>
        <div>
            {% if let Some(prev) = prev_cursor %}
            <a href="/forum/{{ forum_hash }}/pm/conversation/{{ conversation_id }}?cursor={{ prev }}" class="btn btn-small">&larr; Previous</a>
            {% else %}
            {% if current_cursor.is_some() %}
            <a href="/forum/{{ forum_hash }}/pm/conversation/{{ conversation_id }}" class="btn btn-small">&larr; Previous</a>
            {% endif %}
            {% endif %}
            {% if has_more %}
            {% if let Some(cursor) = next_cursor %}
            <a href="/forum/{{ forum_hash }}/pm/conversation/{{ conversation_id }}?cursor={{ cursor }}&prev={{ current_cursor.as_deref().unwrap_or_default() }}" class="btn btn-small">Next &rarr;</a>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Reply Form -->
<div class="card">
    <h2>Send Reply</h2>
    <form method="post" action="/forum/{{ forum_hash }}/pm/conversation/{{ conversation_id }}/reply">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="subject">Subject (optional):</label>
            <input type="text" name="subject" id="subject" maxlength="256" placeholder="Reply subject">
        </div>
        <div class="form-group">
            <label for="body">Message:</label>
            <textarea name="body" id="body" required placeholder="Your reply..." style="height: 120px;"></textarea>
        </div>
        {% if !messages.is_empty() %}
        <div class="form-group">
            <label for="reply_to">Reply to message:</label>
            <select name="reply_to" id="reply_to">
                <option value="">-- No specific message --</option>
                {% for msg in messages %}
                <option value="{{ msg.message_id }}">{{ msg.timestamp_display }} - {{ msg.body|truncate(50) }}...</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="form-group">
            <label for="signing_key">Sign with Key:</label>
            <select name="signing_key" id="signing_key" required>
                {% for key in signing_keys %}
                <option value="{{ key.key_id }}">{{ key.user_id }} ({{ key.fingerprint }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="password">Key Password (if protected):</label>
            <input type="password" name="password" id="password" placeholder="Leave empty if not password-protected">
        </div>
        <button type="submit" class="btn">Send Reply</button>
    </form>
</div>
{% endblock %}
