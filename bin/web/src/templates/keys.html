{% extends "base.html" %} {% block title %}PQPGP - Key Management{% endblock %}
{% block content %} {% if has_result %}
<div class="alert alert-success">
  <strong>{{ result.as_ref().unwrap() }}</strong>
</div>
{% endif %} {% if has_error %}
<div class="alert alert-error">
  <strong>Error:</strong> {{ error.as_ref().unwrap() }}
</div>
{% endif %}

<div class="card">
  <h2><svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10A5.99 5.99 0 0 0 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 0 0 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>Key Management</h2>
  <p>
    Manage your post-quantum cryptographic keys. Generate new key pairs for
    encryption (ML-KEM-1024) or digital signatures (ML-DSA-87).
  </p>

  <form method="post" action="/keys/generate">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <div class="form-group">
      <label for="algorithm">Algorithm Type:</label>
      <select name="algorithm" id="algorithm" required>
        <option value="">Select algorithm...</option>
        <option value="mlkem1024">ML-KEM-1024 - Post-Quantum Encryption</option>
        <option value="mldsa87">
          ML-DSA-87 - Post-Quantum Digital Signatures
        </option>
      </select>
    </div>

    <div class="form-group">
      <label for="user_id">User ID (Name and Email):</label>
      <input
        type="text"
        name="user_id"
        id="user_id"
        placeholder="Alice Smith &lt;alice@example.com&gt;"
        required
        autocomplete="off"
        spellcheck="false"
      />
    </div>

    <div class="form-group">
      <label for="use_password" class="checkbox-label">
        <input
          type="checkbox"
          name="use_password"
          id="use_password"
          onchange="togglePasswordFields()"
        />
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
        Protect private key with password
      </label>
      <small style="color: var(--text-muted); display: block; margin-top: 5px">
        Recommended: Encrypts your private key using Argon2id + AES-256-GCM for
        maximum security.
      </small>
    </div>

    <div id="password_fields" style="display: none">
      <div class="form-group">
        <label for="password">Password:</label>
        <input
          type="password"
          name="password"
          id="password"
          placeholder="Enter a strong password"
          autocomplete="new-password"
          spellcheck="false"
        />
        <small style="color: var(--text-muted); display: block; margin-top: 5px">
          Use a strong, unique password. This will be required for signing and
          decryption operations.
        </small>
      </div>

      <div class="form-group">
        <label for="password_confirm">Confirm Password:</label>
        <input
          type="password"
          name="password_confirm"
          id="password_confirm"
          placeholder="Confirm your password"
          autocomplete="new-password"
          spellcheck="false"
        />
      </div>
    </div>

    <button type="submit" class="btn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10A5.99 5.99 0 0 0 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 0 0 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>Generate New Key Pair</button>

    <script>
      function togglePasswordFields() {
        const usePassword = document.getElementById("use_password").checked;
        const passwordFields = document.getElementById("password_fields");
        const passwordInput = document.getElementById("password");
        const confirmInput = document.getElementById("password_confirm");

        if (usePassword) {
          passwordFields.style.display = "block";
          passwordInput.required = true;
          confirmInput.required = true;
        } else {
          passwordFields.style.display = "none";
          passwordInput.required = false;
          confirmInput.required = false;
          passwordInput.value = "";
          confirmInput.value = "";
        }
      }
    </script>
  </form>
</div>

<div class="card">
  <h2><svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Import Public Key</h2>
  <p>
    Import someone else's public key to encrypt messages for them or verify
    their signatures. You can either paste the key text or upload a key file.
  </p>

  <form method="post" action="/keys/import" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <div class="form-group">
      <label for="public_key">Public Key (PGP Armored Format):</label>
      <textarea
        name="public_key"
        id="public_key"
        rows="10"
        placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----&#10;&#10;Paste the complete public key here...&#10;&#10;-----END PGP PUBLIC KEY BLOCK-----"
        autocomplete="off"
        spellcheck="false"
      ></textarea>
      <small style="color: var(--text-muted); display: block; margin-top: 5px">
        Paste the complete PGP armored public key including the -----BEGIN PGP
        PUBLIC KEY BLOCK----- and -----END PGP PUBLIC KEY BLOCK----- lines.
      </small>
    </div>

    <div
      style="
        text-align: center;
        margin: 20px 0;
        color: var(--text-muted);
        font-weight: bold;
      "
    >
      — OR —
    </div>

    <div class="form-group">
      <label for="key_file">Upload Public Key File:</label>
      <input
        type="file"
        name="key_file"
        id="key_file"
        accept=".asc,.gpg,.pgp,.txt"
        style="
          width: 100%;
          padding: 10px;
          border: 2px dashed #cbd5e0;
          border-radius: 8px;
          background-color: var(--bg-subtle);
        "
      />
      <small style="color: var(--text-muted); display: block; margin-top: 5px">
        Select a file containing the public key. Common formats: .asc (armored),
        .gpg, .pgp, or .txt files.
      </small>
    </div>

    <button type="submit" class="btn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>Import Public Key</button>
  </form>

  <div
    style="
      margin-top: 20px;
      padding: 15px;
      background-color: #f0fff4;
      border: 1px solid #9ae6b4;
      border-radius: 8px;
    "
  >
    <h4 style="margin-top: 0; color: #22543d; display: flex; align-items: center;"><svg class="icon icon-lg" style="margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>Import Options</h4>
    <ul style="margin-bottom: 0; color: #22543d">
      <li>
        Use either the text box OR file upload (both are checked, text takes
        precedence)
      </li>
      <li>Accepted file types: .asc, .gpg, .pgp, .txt</li>
      <li>Files can be armored (text) or binary format</li>
      <li>
        Only public keys will be imported (private keys are ignored for
        security)
      </li>
    </ul>
  </div>
</div>

<div class="card">
  <h2><svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>Your Keys</h2>
  {% if keys.is_empty() %}
  <div class="alert alert-info">
    <p>
      <strong>No keys found.</strong> Generate your first key pair using the
      form above.
    </p>
  </div>
  {% else %}
  <table class="table">
    <thead>
      <tr>
        <th>Key ID</th>
        <th>Fingerprint</th>
        <th>Algorithm</th>
        <th>User IDs</th>
        <th>Private Key</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for key in keys %}
      <tr>
        <td><span class="key-id">{{ key.key_id }}</span></td>
        <td><span class="key-id">{{ key.fingerprint }}</span></td>
        <td>
          {% if key.algorithm == "ML-KEM-1024" %}
          <span
            class="status-badge"
            style="background-color: #bee3f8; color: #2a4365"
            ><svg class="icon" style="margin-right: 4px;" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>{{ key.algorithm }} <small>(Encryption)</small></span
          >
          {% else %}
          <span
            class="status-badge"
            style="background-color: #e6fffa; color: #234e52"
            ><svg class="icon" style="margin-right: 4px;" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>{{ key.algorithm }} <small>(Signatures)</small></span
          >
          {% endif %}
        </td>
        <td>
          {% for user_id in key.user_ids %}
          <div>{{ user_id }}</div>
          {% endfor %}
        </td>
        <td>
          {% if key.has_private_key %} {% if key.is_password_protected %}
          <span class="status-badge status-success"><svg class="icon" style="margin-right: 4px;" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>Protected</span>
          {% else %}
          <span class="status-badge status-success"><svg class="icon" style="margin-right: 4px;" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Available</span>
          {% endif %} {% else %}
          <span class="status-badge status-error"><svg class="icon" style="margin-right: 4px;" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>Not Available</span>
          {% endif %}
        </td>
        <td>
          <div style="display: flex; gap: 8px; flex-wrap: wrap">
            <a
              href="/keys/export/{{ key.key_id }}"
              class="btn btn-small"
              style="
                background-color: #48bb78;
                color: white;
                text-decoration: none;
              "
            >
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>Export
            </a>
            <a
              href="/keys/view/{{ key.key_id }}"
              class="btn btn-small"
              style="
                background-color: var(--red-light);
                color: white;
                text-decoration: none;
              "
            >
              <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>View
            </a>
            <form
              method="post"
              action="/keys/delete/{{ key.key_id }}"
              style="display: inline"
            >
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button
                type="submit"
                class="btn btn-danger btn-small"
                onclick="return confirm('Are you sure you want to delete this key? This action cannot be undone.')"
              >
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete
              </button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div
    style="
      margin-top: 20px;
      padding: 15px;
      background-color: var(--bg-subtle);
      border-radius: 8px;
    "
  >
    <h4 style="margin-top: 0; color: #4a5568; display: flex; align-items: center;"><svg class="icon icon-lg" style="margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>Key Usage Guide</h4>
    <ul style="margin-bottom: 0">
      <li>
        <strong>ML-KEM-1024</strong> keys provide
        <strong>post-quantum encryption</strong> - secure against both classical
        and quantum computer attacks.
      </li>
      <li>
        <strong>ML-DSA-87</strong> keys provide
        <strong>post-quantum digital signatures</strong> - quantum-resistant
        message authentication and integrity.
      </li>
      <li>
        Keys with <strong>private key available</strong> can be used for
        decryption and signing operations.
      </li>
      <li>
        Public keys can be shared with others so they can encrypt messages for
        you or verify your signatures.
      </li>
    </ul>
  </div>
  {% endif %}
</div>

{% endblock %}
